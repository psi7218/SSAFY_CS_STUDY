# 환경 변수 관리

### 1️⃣ 환경 변수란?

- 애플리케이션 실행 환경에서 사용하는 **설정값 저장 방식**임
- OS나 런타임에서 앱에 전달되는 **전역적인 키-값 쌍**임
- `.env` 파일 등을 통해 코드 외부에서 관리되며, 실행 시 `process.env.KEY` 형태로 접근함
- 대표적으로 사용되는 값:
  - DB 접속 정보, API 키, 외부 서비스 인증 정보 등 민감한 설정

- **환경 변수의 장점**
  - **환경에 따라 설정 분리 가능** (개발 / 운영 / 테스트 등)
  - **코드와 설정을 분리**해 보안 및 유지보수에 유리함
  - 다양한 언어와 프레임워크에서 기본적으로 지원함

<br/>

#### 왜 환경 변수에 시크릿 값을 넣으면 안 되는가?

```env
DB_PASSWORD=super-secret-password
JWT_SECRET=very-secret-key
```
- 이런 값들이 노출되면 보안상 매우 치명적

<br/>
<br/>


### 2️⃣ 환경 변수에 시크릿 값을 저장하면 안 되는 이유

#### 1. 보안 문제 및 관리 어려움
  - 시크릿이 **평문으로 저장**되는 경우가 많아 유출 위험 존재
  - 시크릿 유출 시 서비스 **전체 재배포 필요**, 회수 불가
  - 접근 이력 추적 불가, **누가 봤는지 모르는 상태** 발생

#### 2. 프론트엔드와 백엔드 경계 모호 문제
- 메타 프레임워크(Next.js/Nuxt 등)는 **서버/클라이언트 코드가 공존**함 = 서버 전용 시크릿이 클라이언트에 **실수로 노출될 가능성** 존재
  - 메타 프레임워크 : 일반적인 프론트엔드 프레임워크(React, Vue 등)에 서버 기능까지 포함된 프레임워크
  - 같은 파일 구조 안에서 클라이언트, 서버 역할이 모두 포함

    | 역할 | 설명 | 예시 경로 |
    |------|------|-----------|
    | **클라이언트 코드** | 브라우저에서 실행됨 | `/pages/index.tsx`, `/components/Nav.tsx` 등 |
    | **서버 코드** | Node.js 환경에서 실행됨 | `/pages/api/hello.ts`, `getServerSideProps` 내부 등 |

- 번들링 시 브라우저 콘솔을 통해 **API 키 노출** 위험 있음

#### 3. `.env` 파일 유출 가능성

- 실수로 GitHub에 `.env` 파일 커밋되는 경우 다수 발생
- 실제 사례: **New England Biolabs 시크릿 유출 사건** 발생

#### 4. 로그를 통한 시크릿 유출 가능성

- 디버깅 중 `console.log(process.env.SECRET)` 호출 시 로그 서버 전송 위험
- 실제 사례: **Seneca CVE-2019-5483**에서 시크릿 노출

#### 5. 프로세스 간 환경 변수 공유

- 자식 프로세스는 부모의 환경 변수 **기본 상속**함
- 불필요한 권한 확장으로 **최소 권한 원칙 위배** 발생

#### 6. 프로세스 메모리 정보 노출

- UNIX 계열에서는 `/proc/self/environ` 등을 통해 다른 사용자가 환경 변수 조회 가능
- `ps eww <PID>` 명령어로도 확인 가능

#### 7. Docker 이미지에 포함될 수 있음

- 빌드시 `.env`나 build args가 **메타데이터에 포함**될 수 있음
- 연구에 따르면 Docker Hub 이미지의 **약 10%에 민감 정보 포함**됨

<br/>
<br/>

###  3️⃣ 시크릿 값을 안전하게 관리하는 방법

### 1. Secret Zero 문제 해결

- 초기 시크릿 전달을 위한 임시 토큰 사용
- **수명 짧고 1회용인 접근 키**로 초기 인증 수행

### 2. 다양한 시크릿 관리 도구 사용

| 도구 이름               | 특징                                                   |
|----------------------|------------------------------------------------------|
| 1Password (op CLI)    | 비밀번호 앱 기반 시크릿 관리, Node.js 연동 가능             |
| Infisical             | `.env` 대체 오픈소스 도구, 실시간 공유 및 감사 로그 지원      |
| HashiCorp Vault       | 엔터프라이즈급 시크릿/암호화 키 관리, 정책 기반 권한 제어 지원  |
| Google Secret Manager | GCP 전용 시크릿 저장소, IAM 기반 접근 제어 제공            |

### 3. 시크릿 저장과 접근 분리

- 시크릿은 코드에서 직접 접근하지 않고, **시크릿 서버 또는 API 호출을 통해 로딩**
- 애플리케이션 시작 시 **런타임에서만 시크릿을 전달**받아 사용함

<br/>
<br/>

### 4️⃣ SSAFY에서의 시크릿/환경 변수 관리 방식

#### 1. CI/CD 파이프라인을 통한 관리

- GitLab, Jenkins 등을 통해 **빌드/배포 시점에 환경 변수 주입**
- 환경 설정을 코드와 분리해 **중앙 집중 관리** 가능
- 팀별 수동 설정 대신 **일관된 배포 환경 제공**

#### 2. Jasypt를 이용한 환경 변수 암호화

- `.properties` 파일에 **암호화된 설정 값** 저장

    ```properties
    spring.datasource.password=ENC(암호화된문자열)
    ```

- **Jasypt 라이브러리**를 통해 런타임에 복호화 수행
- 복호화 키는 환경 변수로 전달 (1개의 키만 노출)
- **복호화 키만 민감 정보로 관리**, 설정 파일은 Git에 커밋 가능


#### 3. Config 서버 기반 외부 설정 관리

- Spring Cloud Config 등으로 **설정 파일을 Git 기반 원격 저장소에서 관리**
- 여러 애플리케이션이 **같은 설정 파일 공유** 가능
- 설정 변경 시 **재배포 없이 실시간 반영(refresh)** 가능
- 복호화 키는 별도로 분리, 실행 환경에서만 접근 가능하게 설정

<br/>
<br/>
<br/>
<br/>
<br/>


- **환경 변수는 설정 값을 외부화하는 좋은 도구**이지만, **시크릿 값을 저장하기엔 보안상 위험이 많음**
- `.env`는 편리하지만 보안 통제가 어렵고 실수에 취약함
- **프로덕션 환경에서는 반드시 시크릿 관리 도구를 사용**해야 함
- 환경 변수는 최소한으로 사용하고 시크릿은 **암호화 + 접근 제어**된 방식으로 관리 필요

<br/>
<br/>

- 참고 링크
  - [원문](https://www.nodejs-security.com/blog/do-not-use-secrets-in-environment-variables-and-here-is-how-to-do-it-better#is-it-wrong-to-store-secrets-in-environment-variables)
  - [번역본 링크](https://siosio3103.medium.com/%EB%B2%88%EC%97%AD-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98%EC%97%90-%EC%8B%9C%ED%81%AC%EB%A6%BF-%EA%B0%92%EC%9D%84-%EC%A0%80%EC%9E%A5%ED%95%98%EC%A7%80-%EC%95%8A%EA%B3%A0-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%8D%94-%EB%82%98%EC%9D%80-%EB%B0%A9%EB%B2%95-2492274c544a)